{% extends "projects/base.html" %}
{% load static %}

{% block scripts %}
<!-- Schema for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "Font Inspector",
  "description": "Enter a website URL to detect the font families it uses, whether a license is required for each, and where each font is sourced from (Google Fonts, Adobe Fonts, or self-hosted). Download results as CSV.",
  "url": "https://www.bencritt.net/projects/font-inspector/",
  "applicationCategory": "Utility",
  "operatingSystem": "Web-based",
  "image": "",
  "creator": {
    "@type": "Person",
    "name": "Ben Crittenden",
    "url": "https://www.bencritt.net"
  },
  "featureList": [
    "Scans a public webpage to detect font families in use.",
    "Indicates whether each family requires a license.",
    "Identifies the font source (Google Fonts, Adobe Fonts, or self-hosted).",
    "Lets users download the detected fonts as a CSV file.",
    "Processes requests at runtime—no data is permanently stored on the server."
  ]
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('font-inspector-form') || document.querySelector('form');
  if (!form) return;

  const progWrap   = document.getElementById('fi-progress');
  const bar        = document.getElementById('fi-bar');
  const statusText = document.getElementById('fi-status-text');
  const urlInput   = form.querySelector('input[name="url"]');

  function setProgress(pct, msg) {
    if (!progWrap || !bar || !statusText) return;
    const clamped = Math.max(0, Math.min(100, Math.floor(pct)));
    progWrap.style.display = 'block';
    bar.style.width = clamped + '%';
    bar.textContent = clamped + '%';
    const prog = progWrap.querySelector('[role="progressbar"]');
    if (prog) prog.setAttribute('aria-valuenow', String(clamped));
    if (msg) statusText.textContent = msg;
  }

  form.addEventListener('submit', function (ev) {
    const submitter  = ev.submitter || document.activeElement;
    const isDownload = submitter && submitter.name === 'download';

    // GA4 events (no-ops if gtag isn’t present)
    if (isDownload) {
      window.gtag && gtag('event', 'font_scan_download');
    } else {
      window.gtag && gtag('event', 'font_scan_start');
    }

    // Show progress immediately; do NOT prevent default (allow normal POST)
    setProgress(isDownload ? 10 : 5, isDownload ? 'Preparing CSV…' : 'Scanning page…');

    // Harden against double-submits
    urlInput && urlInput.setAttribute('readonly', '');   // optional UX: lock input once submitted
    const btns = form.querySelectorAll('button[type="submit"], input[type="submit"]');
    btns.forEach(b => { if (b !== submitter) b.disabled = true; });

    if (isDownload) {
      // DOWNLOAD FLOW: no navigation → finish to 100% then auto-hide
      let pct = 10;
      const t = setInterval(() => {
        pct = Math.min(100, pct + 10);
        setProgress(pct);
        if (pct >= 100) {
          clearInterval(t);
          statusText.textContent = 'Download started.';
          setTimeout(() => { progWrap.style.display = 'none'; }, 1200);
        }
      }, 120);
      return; // allow normal form submit to trigger file download
    }

    // SCAN FLOW: advance until navigation replaces the page
    let pct = 5;
    const t = setInterval(() => {
      pct = Math.min(90, pct + (pct < 30 ? 3 : pct < 60 ? 2 : 1));
      setProgress(pct);
      if (pct >= 35 && statusText.textContent === 'Scanning page…') {
        statusText.textContent = 'Analyzing fonts…';
      } else if (pct >= 75 && statusText.textContent !== 'Preparing results…') {
        statusText.textContent = 'Preparing results…';
      }
    }, 300);

    // Stop the timer if the page is restored from bfcache after navigation
    window.addEventListener('pageshow', () => { clearInterval(t); }, { once: true });
  }, { passive: true });
});
</script>
{% endblock scripts %}

{% block styles %}
<style>
@media (prefers-reduced-motion: reduce) {
  .progress-bar-animated { animation: none; }
}
</style>
{% endblock styles %}

{% block meta_tags %}
<!-- Prevent browser caching to avoid stale CSRF tokens -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<!-- SEO fundamentals -->
<meta name="description"
      content="Enter a website URL to detect its web fonts, see if a license is required, identify whether fonts come from Google Fonts, Adobe Fonts, or are self-hosted, and download a CSV of results.">
<meta name="keywords"
      content="Font Inspector, detect web fonts, web font checker, Google Fonts, Adobe Fonts, self-hosted fonts, font license, CSS fonts">

<!-- Open Graph (Facebook, LinkedIn, etc.) -->
<meta property="og:url"           content="https://www.bencritt.net/projects/font-inspector/">
<meta property="og:type"          content="website">
<meta property="og:title"         content="Font Inspector – Detect Web Fonts, Licenses & Sources">
<meta property="og:description"   content="Scan any page to list its font families, license requirements, and sources. Export as CSV.">
<meta property="og:image"         content="">

<!-- Twitter Cards -->
<meta name="twitter:card"         content="summary_large_image">
<meta property="twitter:domain"   content="bencritt.net">
<meta property="twitter:url"      content="https://www.bencritt.net/projects/font-inspector/">
<meta name="twitter:title"        content="Font Inspector – Detect Web Fonts, Licenses & Sources">
<meta name="twitter:description"  content="Scan any page to list its font families, license requirements, and sources. Export as CSV.">
<meta name="twitter:image"        content="">
<meta name="twitter:creator"      content="@bencritt89">
{% endblock meta_tags %}


{% block link_tags %}
<!-- Canonical link to help avoid duplicate content issues. -->
<link rel="canonical" href="https://www.bencritt.net/projects/font-inspector/">
{% endblock link_tags %}
{% block title %}Font Inspector | Detect Web Fonts, License Requirements, & Sources{% endblock title %}
{% block content %}
<center>
<div class="container py-4" style="width: 100%; max-width: 700px; margin: auto;">
  <h1>Font Inspector</h1>
  <br>
  <form id="font-inspector-form" method="post" class="mb-4">
    {% csrf_token %}
    <div class="input-group">
      {{ form.url }}
      <button class="btn btn-primary" type="submit">Scan for Fonts</button>
      {% if rows %}
        <button class="btn btn-secondary" type="submit" name="download">Download CSV</button>
      {% endif %}
    </div>
    {% for err in form.url.errors %}
      <div class="text-danger small">{{ err }}</div>
    {% endfor %}
  </form>
  <br>
  <!-- Progress Indicator -->
  <div id="fi-progress"
      class="mt-3"
      style="display:none; max-width:700px;"
      aria-live="polite" aria-atomic="true">
    <div class="d-flex justify-content-between mb-1">
      <span class="small">Status: <span id="fi-status-text">Starting…</span></span>
      <span class="small" id="fi-queue-pos"></span>
    </div>
    <div class="progress"
        role="progressbar"
        aria-label="Font scan progress"
        aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"
        style="height:18px;">
      <div id="fi-bar"
          class="progress-bar progress-bar-striped progress-bar-animated"
          style="width:1%">1%</div>
    </div>
  </div>
  <br>
  <!-- Results Table -->
  {% if rows %}
  <div class="table-responsive">
    <table class="table table-dark table-striped align-middle">
      <thead>
        <tr>
          <th>Website</th><th>Family</th>
          <th>License Required</th><th>Font Source</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          <tr>
            <td>{{ r.website }}</td>
            <td>{{ r.family }}</td>
            <td>{{ r.license_required }}</td>
            <td>{{ r.font_source }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    window.gtag && gtag('event', 'font_scan_complete');
  });
  </script>
  {% endif %}
</div>
</center>
{% endblock %}
