{% extends "projects/base.html" %}
{% load static %}

{% block scripts %}
  <!-- Schema for SEO -->
  {% include "includes/schemas/font_inspector_schema.html" %}
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('font-inspector-form') || document.querySelector('form');
    if (!form) return;

    const progWrap   = document.getElementById('fi-progress');
    const bar        = document.getElementById('fi-bar');
    const statusText = document.getElementById('fi-status-text');
    const queuePosEl = document.getElementById('fi-queue-pos');
    const urlInput   = form.querySelector('input[name="url"]');
    const tableWrap  = document.getElementById('fi-results');
    const dlBtn      = document.getElementById('fi-dl');

    const startUrl  = "{% url 'projects:start_font_inspector' %}";
    const statusTpl = "{% url 'projects:fi_task_status' 'TASKID' %}";
    const rowsTpl   = "{% url 'projects:fi_rows' 'TASKID' %}";
    const dlTpl     = "{% url 'projects:fi_download' 'TASKID' %}";

    function csrfToken() {
      const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
      if (m) return decodeURIComponent(m[1]);
      const t = form.querySelector('input[name="csrfmiddlewaretoken"]');
      return t ? t.value : '';
    }

    function setProgress(pct, msg, qpos) {
      const clamped = Math.max(0, Math.min(100, Math.floor(pct)));
      progWrap.style.display = 'block';
      bar.style.width = clamped + '%';
      bar.textContent = clamped + '%';
      const prog = progWrap.querySelector('[role="progressbar"]');
      if (prog) prog.setAttribute('aria-valuenow', String(clamped));
      statusText.textContent = msg || '';
      queuePosEl.textContent = qpos && qpos > 0 ? `Place in queue: ${qpos}` : '';
    }

    function disableButtons(disabled) {
      const btns = form.querySelectorAll('button[type="submit"], input[type="submit"], button[type="button"]');
      btns.forEach(b => b.disabled = !!disabled);
      if (disabled) urlInput && urlInput.setAttribute('readonly', '');
      else urlInput && urlInput.removeAttribute('readonly');
    }

    function renderTable(rows) {
      if (!rows || !rows.length) {
        tableWrap.innerHTML = '';
        return;
      }

      const head = `
        <thead><tr>
          <th>Website</th><th>Family</th><th>License Required</th><th>Font Source</th>
        </tr></thead>`;

      // IMPORTANT: data-label attributes support “cards” layout in iframes.
      const body = rows.map(r => `
        <tr>
          <td data-label="Website">${r.website}</td>
          <td data-label="Family">${r.family}</td>
          <td data-label="License Required">${r.license_required}</td>
          <td data-label="Font Source">${r.font_source}</td>
        </tr>`).join('');

      tableWrap.innerHTML = `
        <div class="table-responsive">
          <table class="table table-dark table-striped align-middle">
            ${head}<tbody>${body}</tbody>
          </table>
        </div>
      `;
    }

    let pollTimer = null;

    async function poll(taskId) {
      try {
        const res = await fetch(statusTpl.replace('TASKID', taskId), { credentials: 'same-origin' });
        const j = await res.json();
        setProgress(j.progress ?? 0, j.message || '', j.queue_position || 0);

        if (j.status === 'QUEUED' || j.status === 'RUNNING') return;

        if (j.status === 'DONE') {
          try {
            const rr = await fetch(rowsTpl.replace('TASKID', taskId), { credentials: 'same-origin' });
            const rj = await rr.json();
            renderTable(rj.rows || []);
          } catch {}
          disableButtons(false);
          if (dlBtn) {
            dlBtn.dataset.taskId = taskId;
            dlBtn.style.display = 'inline-block';
            dlBtn.disabled = false;
          }
        } else if (j.status === 'ERROR') {
          disableButtons(false);
          statusText.textContent = j.message || 'Error.';
        }

        if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
      } catch (e) {
        // transient errors; keep polling
      }
    }

    if (dlBtn) {
      dlBtn.addEventListener('click', function () {
        const taskId = dlBtn.dataset.taskId;
        if (!taskId) return;
        progWrap.style.display = 'none';
        dlBtn.style.display = 'none';
        window.location.href = dlTpl.replace('TASKID', taskId);
      });
    }

    form.addEventListener('submit', async function (ev) {
      ev.preventDefault();

      const url = (urlInput.value || '').trim();
      if (!url) return;

      window.gtag && gtag('event', 'font_scan_start');

      renderTable([]);
      setProgress(2, 'Starting…', 0);
      disableButtons(true);
      if (dlBtn) { dlBtn.disabled = true; dlBtn.style.display = 'none'; dlBtn.dataset.taskId = ''; }

      try {
        const resp = await fetch(startUrl, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrfToken(), 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ url }),
          credentials: 'same-origin',
        });
        if (!resp.ok) throw new Error('Start failed');
        const j = await resp.json();
        setProgress(3, j.status === 'QUEUED' ? 'Queued…' : 'Running…', j.queue_position || 0);

        if (pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(() => poll(j.task_id), 650);
      } catch (e) {
        disableButtons(false);
        statusText.textContent = 'Error starting task.';
      }
    }, { passive: false });
  });
  </script>
{% endblock scripts %}

{% block styles %}
{% endblock styles %}

{% block meta_tags %}
<meta http-equiv="Cache-Control"  content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma"         content="no-cache">
<meta http-equiv="Expires"        content="0">

<meta name="description"          content="Enter a website URL to detect its web fonts, see if a license is required, identify whether fonts come from Google Fonts, Adobe Fonts, or are self-hosted, and download a CSV of results.">
<meta name="keywords"             content="Font Inspector, detect web fonts, web font checker, Google Fonts, Adobe Fonts, self-hosted fonts, font license, CSS fonts">

<meta property="og:url"           content="https://www.bencritt.net/projects/font-inspector/">
<meta property="og:type"          content="website">
<meta property="og:title"         content="Font Inspector – Detect Web Fonts, Licenses & Sources">
<meta property="og:description"   content="Scan any page to list its font families, license requirements, and sources. Export as CSV.">
<meta property="og:image"         content="https://www.bencritt.net/static/img/all-projects/font-inspector.webp">
<meta property="og:image:type"    content="image/webp">
<meta property="og:image:alt"     content="Font Inspector Screenshot">
<meta property="og:site_name"     content="Ben Crittenden">

<meta name="twitter:card"         content="summary_large_image">
<meta name="twitter:domain"       content="bencritt.net">
<meta name="twitter:url"          content="https://www.bencritt.net/projects/font-inspector/">
<meta name="twitter:title"        content="Font Inspector – Detect Web Fonts, Licenses & Sources">
<meta name="twitter:description"  content="Scan any page to list its font families, license requirements, and sources. Export as CSV.">
<meta name="twitter:image"        content="https://www.bencritt.net/static/img/all-projects/font-inspector.webp">
<meta name="twitter:creator"      content="@bencritt89">
{% endblock meta_tags %}

{% block link_tags %}
<link rel="canonical" href="https://www.bencritt.net/projects/font-inspector/">
<link href="{% static 'template-css/font-inspector-css.css' %}" rel="stylesheet">
{% endblock link_tags %}

{% block title %}Font Inspector | Detect Web Fonts, License Requirements, & Sources{% endblock title %}

{% block content %}
<main>
  <center>
    <div class="container py-4" style="width: 100%; max-width: 700px; margin: auto;">
      <h1>Font Inspector</h1>
      <br>
      <p>Enter the URL of a web page. A table below will identify all fonts, font sources, and offer guidance on license requirements.</p>

      <form id="font-inspector-form" class="mb-4">
        {% csrf_token %}
        <div class="input-group">
          {{ form.url }}
          <button class="btn btn-primary" type="submit">Scan Fonts</button>
          <button id="fi-dl" class="btn btn-outline-secondary" type="button" disabled style="display:none;">Download CSV</button>
        </div>
      </form>

      <!-- Progress Indicator -->
      <div id="fi-progress"
          class="mt-3"
          style="display:none; max-width:700px;"
          aria-live="polite" aria-atomic="true">
        <div class="d-flex justify-content-between mb-1">
          <span class="small">Status: <span id="fi-status-text">Starting…</span></span>
          <span class="small" id="fi-queue-pos"></span>
        </div>
        <div class="progress"
            role="progressbar"
            aria-label="Font scan progress"
            aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"
            style="height:18px;">
          <div id="fi-bar"
              class="progress-bar progress-bar-striped progress-bar-animated"
              style="width:1%">1%</div>
        </div>
      </div>

      <br>

      <!-- Results (FIXED: proper nesting + scroll container focusable) -->
      <div id="fi-results-area" tabindex="0">
        <div id="fi-results"></div>
        <p class="mt-2 text-muted small">CSV files are stored temporarily and auto-deleted after 30 minutes.</p>
      </div>

    </div>

    <br>

{% include 'includes/attribution.html' %}
  </center>
</main>
{% endblock content %}
