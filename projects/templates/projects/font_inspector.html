{% extends "projects/base.html" %}
{% load static %}

{% block scripts %}
  {% include "includes/schemas/font_inspector_schema.html" %}
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('font-inspector-form') || document.querySelector('form');
    if (!form) return;

    const progWrap   = document.getElementById('fi-progress');
    const bar        = document.getElementById('fi-bar');
    const statusText = document.getElementById('fi-status-text');
    const queuePosEl = document.getElementById('fi-queue-pos');
    const urlInput   = form.querySelector('input[name="url"]');
    const tableWrap  = document.getElementById('fi-results');
    const dlBtn      = document.getElementById('fi-dl');

    const startUrl  = "{% url 'projects:start_font_inspector' %}";
    const statusTpl = "{% url 'projects:fi_task_status' 'TASKID' %}";
    const rowsTpl   = "{% url 'projects:fi_rows' 'TASKID' %}";
    const dlTpl     = "{% url 'projects:fi_download' 'TASKID' %}";

    function csrfToken() {
      const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
      if (m) return decodeURIComponent(m[1]);
      const t = form.querySelector('input[name="csrfmiddlewaretoken"]');
      return t ? t.value : '';
    }

    function setProgress(pct, msg, qpos) {
      const clamped = Math.max(0, Math.min(100, Math.floor(pct)));
      
      progWrap.classList.remove('d-none');
      
      bar.style.width = clamped + '%';
      bar.textContent = clamped + '%';
      bar.setAttribute('aria-valuenow', String(clamped));
      
      if (msg) statusText.textContent = msg;
      queuePosEl.textContent = qpos && qpos > 0 ? `Place in queue: ${qpos}` : '';
    }

    function showDownloadButton(taskId) {
        if (!dlBtn) return;
        dlBtn.dataset.taskId = taskId;
        dlBtn.disabled = false;
        dlBtn.classList.remove('d-none');
    }

    function resetUI() {
        progWrap.classList.add('d-none');
        if (dlBtn) {
            dlBtn.classList.add('d-none');
            dlBtn.disabled = true;
        }
        disableButtons(false);
    }

    function disableButtons(disabled) {
      const btns = form.querySelectorAll('button[type="submit"], input[type="submit"], button[type="button"]');
      btns.forEach(b => {
          // Don't disable the download button if we are just unlocking the form
          if (b.id !== 'fi-dl') b.disabled = !!disabled;
      });
      if (disabled) urlInput && urlInput.setAttribute('readonly', '');
      else urlInput && urlInput.removeAttribute('readonly');
    }

    function renderTable(rows) {
      if (!rows || !rows.length) {
        tableWrap.innerHTML = '<div class="alert alert-info mt-3 text-center">No fonts detected on that page.</div>';
        return;
      }

      const head = `
        <thead><tr>
          <th>Website</th><th>Family</th><th>License Required</th><th>Font Source</th>
        </tr></thead>`;

      const body = rows.map(r => {
        let badgeClass = 'bg-secondary';
        if (r.license_required === 'Yes') badgeClass = 'bg-danger';
        if (r.license_required === 'No') badgeClass = 'bg-success';
        if (r.license_required === 'Unknown') badgeClass = 'bg-warning text-dark';

        return `
        <tr>
          <td data-label="Website" class="text-muted small">${r.website}</td>
          <td data-label="Family"><strong>${r.family}</strong></td>
          <td data-label="License Required"><span class="badge ${badgeClass}">${r.license_required}</span></td>
          <td data-label="Font Source">${r.font_source}</td>
        </tr>`;
      }).join('');

      tableWrap.innerHTML = `
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            ${head}<tbody>${body}</tbody>
          </table>
        </div>
      `;
    }

    let pollTimer = null;

    async function poll(taskId) {
      try {
        const res = await fetch(statusTpl.replace('TASKID', taskId), { credentials: 'same-origin' });
        if (!res.ok) throw new Error("Status check failed");
        
        const j = await res.json();
        
        setProgress(j.progress ?? 0, j.message || '', j.queue_position || 0);

        if (j.status === 'QUEUED' || j.status === 'RUNNING') return;

        if (j.status === 'DONE') {
          if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
          
          try {
            const rr = await fetch(rowsTpl.replace('TASKID', taskId), { credentials: 'same-origin' });
            const rj = await rr.json();
            renderTable(rj.rows || []);
          } catch (err) {
            console.error(err);
            tableWrap.innerHTML = '<div class="alert alert-danger">Error loading results.</div>';
          }
          
          disableButtons(false);
          setProgress(100, "Complete!", 0);
          showDownloadButton(taskId);

        } else if (j.status === 'ERROR') {
          if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
          disableButtons(false);
          statusText.textContent = j.message || 'Error.';
          alert(j.message || "An error occurred.");
        }

      } catch (e) {
        console.warn("Poll error:", e);
      }
    }

    if (dlBtn) {
      dlBtn.addEventListener('click', function () {
        const taskId = dlBtn.dataset.taskId;
        if (!taskId) return;
        
        // --- FIX: Hide button immediately upon click ---
        dlBtn.classList.add('d-none');
        
        // Trigger the download
        window.location.href = dlTpl.replace('TASKID', taskId);
      });
    }

    form.addEventListener('submit', async function (ev) {
      ev.preventDefault();

      const url = (urlInput.value || '').trim();
      if (!url) return;

      if (window.gtag) gtag('event', 'font_scan_start');

      tableWrap.innerHTML = '';
      resetUI(); 
      
      setProgress(1, 'Starting…', 0);
      disableButtons(true);

      try {
        const resp = await fetch(startUrl, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrfToken(), 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ url }),
          credentials: 'same-origin',
        });
        
        if (!resp.ok) throw new Error('Start failed');
        
        const j = await resp.json();
        setProgress(5, j.status === 'QUEUED' ? 'Queued…' : 'Running…', j.queue_position || 0);

        if (pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(() => poll(j.task_id), 1000);
      } catch (e) {
        console.error(e);
        disableButtons(false);
        statusText.textContent = 'Error starting task.';
        alert("Could not start the scan. Please check your connection.");
      }
    }, { passive: false });
  });
  </script>
{% endblock scripts %}

{% block meta_tags %}
  {% include "includes/meta_tags/font_inspector_meta.html" %}
{% endblock meta_tags %}

{% block link_tags %}
  {{ block.super }}
  <link rel="canonical" href="https://www.bencritt.net/projects/font-inspector/">
{% endblock link_tags %}

{% block page_stylesheets %}
  <link href="{% static 'template_css/font_inspector.css' %}" rel="stylesheet">
{% endblock page_stylesheets %}

{% block title %}Font Inspector | Detect Web Fonts, License Requirements, & Sources{% endblock title %}

{% block content %}
<div class="container py-5 d-flex flex-column align-items-center">
  
  <h1 class="mb-4">Font Inspector</h1>
  
  <div class="w-100 font-inspector-container">
    <p class="text-center mb-4">Enter the URL of a web page. A table below will identify all fonts, font sources, and offer guidance on license requirements.</p>

    <form id="font-inspector-form" class="mb-4">
      {% csrf_token %}
      <div class="input-group">
        <label for="{{ form.url.id_for_label }}" class="visually-hidden">Website URL</label>
        {{ form.url }}
        <button class="btn btn-primary" type="submit">Scan Fonts</button>
        <button id="fi-dl" class="btn btn-outline-secondary d-none" type="button" disabled>Download CSV</button>
      </div>
    </form>

    <div id="fi-progress" class="mt-3 d-none" aria-live="polite">
      <div class="d-flex justify-content-between mb-1">
        <span class="small">Status: <span id="fi-status-text">Starting…</span></span>
        <span class="small" id="fi-queue-pos"></span>
      </div>
      <div class="progress font-progress-wrapper">
        <div id="fi-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:1%">1%</div>
      </div>
    </div>

    <div id="fi-results-area" class="mt-5" tabindex="0">
      <div id="fi-results"></div>
      <p class="mt-2 text-muted small text-center">CSV files are stored temporarily and auto-deleted after 30 minutes.</p>
    </div>

  </div>

  <div class="mt-5 text-center">
    {% include 'includes/attribution.html' %}
  </div>

</div>
<script>
  if (window.self !== window.top) {
    document.documentElement.classList.add("embedded");
  }
</script>
{% endblock content %}