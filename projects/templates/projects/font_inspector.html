{% extends "projects/base.html" %}
{% load static %}

{% block meta_tags %}
  <!-- Prevent caching (helps avoid stale CSRF token edge cases) -->
  <meta http-equiv="Cache-Control"  content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma"         content="no-cache">
  <meta http-equiv="Expires"        content="0">

  <meta name="description" content="Enter a website URL to detect what fonts are being used, whether they are from Google Fonts, Adobe Fonts, or are self-hosted, and download a CSV of results.">
  <meta name="keywords" content="Font Inspector, detect web fonts, font license, Google Fonts, Adobe Fonts, self-hosted fonts, font families, CSS fonts">

  <meta property="og:url" content="https://www.bencritt.net/projects/font-inspector/">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Font Inspector – Detect Web Fonts, Licenses & Sources">
  <meta property="og:description" content="Scan any page to list detected font families, license requirements, and sources. Export as CSV.">
  <meta property="og:image" content="https://www.bencritt.net/static/img/all-projects/font-inspector.webp">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:domain" content="bencritt.net">
  <meta name="twitter:url" content="https://www.bencritt.net/projects/font-inspector/">
  <meta name="twitter:title" content="Font Inspector – Detect Web Fonts, Licenses & Sources">
  <meta name="twitter:description" content="Scan any page to list detected font families, license requirements, and sources. Export as CSV.">
  <meta name="twitter:image" content="https://www.bencritt.net/static/img/all-projects/font-inspector.webp">
  <meta name="twitter:creator" content="@bencritt89"/>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "Font Inspector",
    "description": "Scan a public webpage to detect which font families are in use, whether they require licenses, and where they are hosted (Google Fonts, Adobe Fonts, or self-hosted). Download results as CSV.",
    "url": "https://www.bencritt.net/projects/font-inspector/",
    "applicationCategory": "DeveloperApplication",
    "operatingSystem": "Web-based",
    "image": "https://www.bencritt.net/static/img/all-projects/font-inspector.webp",
    "creator": {
      "@type": "Person",
      "name": "Ben Crittenden",
      "url": "https://www.bencritt.net"
    },
    "featureList": [
      "Scans a public webpage to detect font families in use.",
      "Indicates whether each family requires a license.",
      "Identifies the font source (Google Fonts, Adobe Fonts, or self-hosted).",
      "Lets users download the detected fonts as a CSV file.",
      "Processes requests at runtime—no data is permanently stored on the server."
    ]
  }
  </script>
{% endblock meta_tags %}

{% block link_tags %}
  <link rel="canonical" href="https://www.bencritt.net/projects/font-inspector/">
  <link href="{% static 'template-css/font-inspector-css.css' %}" rel="stylesheet">
{% endblock link_tags %}

{% block title %}Font Inspector | Detect Web Fonts, Licenses & Sources{% endblock title %}

{% block content %}
  <section class="py-4">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-8">

          <header class="text-center mb-4">
            <h1 class="mb-2">Font Inspector</h1>
            <p class="mb-0 text-muted">
              Enter a URL to scan for font families, sources (Google/Adobe/self-hosted), and license requirements.
            </p>
          </header>

          <section aria-label="Font Inspector Form" class="mb-4">
            <form
              id="font-inspector-form"
              method="post"
              action="{% url 'projects:start_font_inspector' %}"
              class="mb-3"
              novalidate
            >
              {% csrf_token %}

              <div class="input-group">
                {{ form.url }}
                <button class="btn btn-primary" type="submit">Scan for Fonts</button>

                <!-- Hidden by default; JS will remove d-none when ready -->
                <button id="fi-dl" class="btn btn-secondary d-none" type="button" disabled>
                  Download CSV
                </button>
              </div>

              {% for error in form.url.errors %}
                <div class="text-danger mt-2">{{ error }}</div>
              {% endfor %}
            </form>

            <!-- Progress -->
            <div id="fi-progress" class="mt-3 d-none" aria-live="polite" aria-atomic="true">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="small">Status: <span id="fi-status-text">Starting…</span></span>
                <span class="small" id="fi-queue-pos"></span>
              </div>

              <div
                class="progress fi-progressbar"
                role="progressbar"
                aria-label="Font scan progress"
                aria-valuemin="0"
                aria-valuemax="100"
                aria-valuenow="0"
              >
                <div
                  id="fi-bar"
                  class="progress-bar progress-bar-striped progress-bar-animated"
                >1%</div>
              </div>
            </div>
          </section>

          <!-- Results -->
          <section aria-label="Font Inspector Results">
            <div id="fi-results-area" tabindex="0">
              <div id="fi-results"></div>
            </div>
          </section>

          <div class="text-center mt-4">
            <a
              href="https://github.com/BenCritt/profile_workspace_heroku"
              target="_blank"
              rel="noopener noreferrer"
              class="btn btn-outline-secondary"
              data-bs-toggle="tooltip"
              title="View the source code for this app.">
              View source on GitHub
            </a>

            <p class="mt-3 text-muted small mb-0">
              This tool was created by
              <a href="{% url 'projects:home' %}" class="content-link" title="Ben Crittenden – IT Professional">Ben Crittenden</a>,
              an IT professional with experience in web development, systems administration, and project management.
            </p>
          </div>

        </div>
      </div>
    </div>
  </section>

  <script>
  (function () {
    try {
      const params = new URLSearchParams(window.location.search);
      const embeddedParam = params.get("embedded") === "1";
      const inIframe = window.self !== window.top; // may throw cross-origin
      if (embeddedParam || inIframe) {
        document.documentElement.classList.add("embedded");
      }
    } catch (e) {
      // If cross-origin blocks window.top, assume iframe
      document.documentElement.classList.add("embedded");
    }
  })();
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('font-inspector-form') || document.querySelector('form');
      if (!form) return;

      const progWrap   = document.getElementById('fi-progress');
      const bar        = document.getElementById('fi-bar');
      const statusText = document.getElementById('fi-status-text');
      const queuePosEl = document.getElementById('fi-queue-pos');
      const urlInput   = form.querySelector('input[name="url"]');
      const tableWrap  = document.getElementById('fi-results');
      const dlBtn      = document.getElementById('fi-dl');

      const startUrl  = "{% url 'projects:start_font_inspector' %}";
      const statusTpl = "{% url 'projects:fi_task_status' 'TASKID' %}";
      const rowsTpl   = "{% url 'projects:fi_rows' 'TASKID' %}";
      const dlTpl     = "{% url 'projects:fi_download' 'TASKID' %}";

      // Initialize UI state (avoid inline styles in markup)
      if (bar) { bar.style.width = '1%'; bar.textContent = '1%'; }
      if (dlBtn) { dlBtn.classList.add('d-none'); }

      function csrfToken() {
        const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
        if (m) return decodeURIComponent(m[1]);
        const t = form.querySelector('input[name="csrfmiddlewaretoken"]');
        return t ? t.value : '';
      }

      function escapeHtml(s) {
        return String(s ?? '').replace(/[&<>"']/g, (c) => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[c]));
      }

      function showProgress() {
        if (progWrap) progWrap.classList.remove('d-none');
      }

      function hideProgress() {
        if (progWrap) progWrap.classList.add('d-none');
      }

      function setProgress(pct, msg, qpos) {
        const clamped = Math.max(0, Math.min(100, Number(pct || 0)));
        if (bar) {
          bar.style.width = clamped + '%';
          bar.textContent = clamped + '%';
        }
        if (statusText && msg) statusText.textContent = msg;
        if (queuePosEl) queuePosEl.textContent = qpos ? `Queue position: ${qpos}` : '';
      }

      function renderTable(rows) {
        if (!tableWrap) return;

        if (!Array.isArray(rows) || rows.length === 0) {
          tableWrap.innerHTML = '<p class="text-muted">No fonts detected.</p>';
          return;
        }

        const head = `
          <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
              <thead>
                <tr>
                  <th scope="col">Font family</th>
                  <th scope="col">Source</th>
                  <th scope="col">License required</th>
                  <th scope="col">Notes</th>
                </tr>
              </thead>
              <tbody>
        `;

        const body = rows.map(r => `
          <tr>
            <td data-label="Font family">${escapeHtml(r.family)}</td>
            <td data-label="Source">${escapeHtml(r.source)}</td>
            <td data-label="License required">${escapeHtml(r.license_required)}</td>
            <td data-label="Notes">${escapeHtml(r.notes)}</td>
          </tr>
        `).join('');

        const tail = `
              </tbody>
            </table>
          </div>
        `;

        tableWrap.innerHTML = head + body + tail;
      }

      let pollTimer = null;

      function stopPolling() {
        if (pollTimer) window.clearInterval(pollTimer);
        pollTimer = null;
      }

      async function poll(taskId) {
        const url = statusTpl.replace('TASKID', taskId);

        try {
          const r = await fetch(url, { credentials: 'same-origin' });
          const j = await r.json();

          const pct  = j.progress_percent ?? 0;
          const msg  = j.status_message ?? 'Working…';
          const qpos = j.queue_position ?? '';

          showProgress();
          setProgress(pct, msg, qpos);

          if (j.state === 'SUCCESS') {
            stopPolling();

            // Fetch rows for table display
            const rowsUrl = rowsTpl.replace('TASKID', taskId);
            const rr = await fetch(rowsUrl, { credentials: 'same-origin' });
            const rows = await rr.json();
            renderTable(rows);

            // Enable download
            if (dlBtn) {
              dlBtn.dataset.taskId = taskId;
              dlBtn.classList.remove('d-none');
              dlBtn.disabled = false;
            }

            hideProgress();
            document.getElementById('fi-results-area')?.focus();
          }

          if (j.state === 'FAILURE') {
            stopPolling();
            hideProgress();
            if (tableWrap) tableWrap.innerHTML = `<div class="alert alert-danger">Scan failed. Please try again.</div>`;
            if (dlBtn) {
              dlBtn.disabled = true;
              dlBtn.classList.add('d-none');
              dlBtn.dataset.taskId = '';
            }
          }
        } catch (e) {
          stopPolling();
          hideProgress();
          if (tableWrap) tableWrap.innerHTML = `<div class="alert alert-danger">Error polling status. Please try again.</div>`;
        }
      }

      async function startScan(url) {
        stopPolling();
        if (tableWrap) tableWrap.innerHTML = '';
        if (dlBtn) {
          dlBtn.disabled = true;
          dlBtn.classList.add('d-none');
          dlBtn.dataset.taskId = '';
        }

        showProgress();
        setProgress(1, 'Starting…', '');

        const payload = new FormData();
        payload.append('url', url);

        const r = await fetch(startUrl, {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'X-CSRFToken': csrfToken() },
          body: payload
        });

        const j = await r.json();
        if (!j.task_id) throw new Error('No task id returned');

        pollTimer = window.setInterval(() => poll(j.task_id), 1200);
      }

      form.addEventListener('submit', async function (ev) {
        ev.preventDefault();
        const url = urlInput?.value?.trim();
        if (!url) return;

        try {
          await startScan(url);
        } catch (e) {
          hideProgress();
          if (tableWrap) tableWrap.innerHTML = `<div class="alert alert-danger">Could not start scan. Please try again.</div>`;
        }
      });

      if (dlBtn) {
        dlBtn.addEventListener('click', function () {
          const taskId = dlBtn.dataset.taskId;
          if (!taskId) return;

          const u = dlTpl.replace('TASKID', taskId);
          window.location.href = u;
        });
      }
    });
  </script>
{% endblock content %}