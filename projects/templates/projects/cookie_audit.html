{% extends "projects/base.html" %}
{% load static %}

{% block scripts %}
  {% include "includes/schemas/cookie_audit_schema.html" %}
{% endblock scripts %}

{% block meta_tags %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<meta name="description" content="Scan any public web page to detect cookies in use and view key attributes like domain, expiration, HttpOnly, Secure, and SameSite.">

<meta property="og:url" content="https://www.bencritt.net/projects/cookie-audit/">
<meta property="og:type" content="website">
<meta property="og:title" content="Cookie Audit – Detect Cookies and Basic Cookie Information">
<meta property="og:description" content="Scan any page to list its cookies and view key cookie attributes like expiration, HttpOnly, Secure, and SameSite.">
<meta property="og:image" content="https://www.bencritt.net/static/img/all-projects/cookie-audit.webp">
<meta property="og:image:type" content="image/webp">
<meta property="og:image:alt" content="Cookie Audit tool screenshot showing a cookie results table">
<meta property="og:site_name" content="Ben Crittenden">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:domain" content="bencritt.net">
<meta name="twitter:url" content="https://www.bencritt.net/projects/cookie-audit/">
<meta name="twitter:title" content="Cookie Audit – Detect Cookies and Basic Cookie Information">
<meta name="twitter:description" content="Scan a URL to detect cookies and view key attributes like domain, expiration, HttpOnly, Secure, and SameSite.">
<meta name="twitter:image" content="https://www.bencritt.net/static/img/all-projects/cookie-audit.webp">
<meta name="twitter:creator" content="@bencritt89">
{% endblock meta_tags %}

{% block styles %}
<style>
/* Keep table from expanding; wrap cell contents instead */
.cookie-table {
  width: 100%;
  table-layout: fixed;
}

/* Body cells: allow wrapping anywhere so long tokens don't widen table */
.cookie-table td {
  white-space: normal !important;
  overflow-wrap: anywhere;
  word-break: break-word;
  vertical-align: top;
}

/* Header cells: default = DO NOT wrap single-word headings */
.cookie-table th {
  white-space: nowrap !important;
  overflow-wrap: normal !important;
  word-break: normal !important;
  vertical-align: bottom;
}

/* Allow specific headings to wrap (HttpOnly / SameSite, and any 2-word headings if you choose) */
.cookie-table th.th-wrap {
  white-space: normal !important;
}

/* Let <code> wrap in body cells */
.cookie-table td code {
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
  display: inline-block;
  max-width: 100%;
}

/* ✅ Mobile: turn the table into stacked "cards" */
@media (max-width: 576px) {
  .cookie-table {
    table-layout: auto;
  }

  .cookie-table thead {
    display: none;
  }

  .cookie-table,
  .cookie-table tbody,
  .cookie-table tr,
  .cookie-table td {
    display: block;
    width: 100%;
  }

  .cookie-table tr {
    border: 1px solid var(--bs-border-color, rgba(255,255,255,.2));
    border-radius: 0.75rem;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    background: var(--bs-body-bg, transparent);
  }

  .cookie-table td {
    border: 0 !important;
    padding: 0.35rem 0 !important;
    display: flex;
    gap: 0.75rem;
    align-items: baseline;
  }

  .cookie-table td::before {
    content: attr(data-label);
    font-weight: 600;
    flex: 0 0 7.5rem;
    max-width: 7.5rem;
    opacity: 0.9;
  }

  .cookie-table td code {
    max-width: 100%;
  }
}

/* =========================================================
   EMBEDDED (inside iframe): ONE vertical scrollbar only
   - Disable page scrolling
   - Make results/cards area the only scroll region
   ========================================================= */

/* Kill page/body scrolling when embedded */
html.embedded,
html.embedded body {
  height: 100%;
  overflow: hidden !important; /* important: prevent second scrollbar */
}

/* Use a header + scrollable results layout */
html.embedded .cookie-audit-main {
  height: 100vh;
}

html.embedded .cookie-audit-layout {
  height: 100%;
  display: flex;
  flex-direction: column;
}

html.embedded .cookie-audit-header {
  flex: 0 0 auto;
}

/* This is the ONE scrollbar you want (scroll through the cards/results) */
html.embedded .cookie-audit-results {
  flex: 1 1 auto;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
  padding-right: 6px; /* prevents scrollbar overlay */
}

/* Hide footer/GitHub section inside the iframe */
html.embedded .cookie-audit-footer {
  display: none !important;
}

/* Hide base template nav/footer inside the iframe to avoid extra height */
html.embedded .navbar,
html.embedded footer,
html.embedded .footer,
html.embedded .fixed-bottom {
  display: none !important;
  position: static !important;
}

/* Force the “table → cards” layout when embedded (even on desktop) */
html.embedded .cookie-table thead {
  display: none;
}

html.embedded .cookie-table {
  table-layout: auto;
}

html.embedded .cookie-table,
html.embedded .cookie-table tbody,
html.embedded .cookie-table tr,
html.embedded .cookie-table td {
  display: block;
  width: 100%;
}

html.embedded .cookie-table tr {
  border: 1px solid var(--bs-border-color, rgba(255,255,255,.2));
  border-radius: 0.75rem;
  padding: 0.75rem;
  margin-bottom: 0.75rem;
  background: var(--bs-body-bg, transparent);
}

html.embedded .cookie-table td {
  border: 0 !important;
  padding: 0.35rem 0 !important;
  display: flex;
  gap: 0.75rem;
  align-items: baseline;
  flex-wrap: wrap;
}

html.embedded .cookie-table td::before {
  content: attr(data-label);
  font-weight: 600;
  flex: 0 0 7.5rem;
  max-width: 7.5rem;
  opacity: 0.9;
}

html.embedded .cookie-table td > * {
  min-width: 0;
}
</style>
{% endblock styles %}

{% block link_tags %}
<link rel="canonical" href="https://www.bencritt.net/projects/cookie-audit/">
{% endblock link_tags %}

{% block title %}Cookie Audit | Detect Cookies and Basic Cookie Information{% endblock title %}

{% block content %}
<div class="container py-5 d-flex flex-column align-items-center cookie-audit-main">

  <div class="w-100 cookie-audit-layout" style="max-width: 900px;">
      
      <div class="text-center mb-5 cookie-audit-header">
        <h1 class="mb-3">Cookie Audit</h1>
        <p class="text-muted">Enter the URL of a web page. A table below will identify cookies. Due to server limitations, the scan will stop if page count, memory, or timeout thresholds are met.</p>
        
        <div class="d-flex justify-content-center mt-4">
          <form method="post"
              class="w-100"
              style="max-width: 700px;"
              id="cookieAuditForm"
              action="{% url 'projects:cookie_audit_start' %}"
              novalidate>
            {% csrf_token %}

            <div class="input-group shadow-sm">
              <label for="{{ form.url.id_for_label }}" class="visually-hidden">Website URL</label>
              {{ form.url }}
              <button class="btn btn-primary" type="submit" id="scanBtn">Scan Cookies</button>
              <button class="btn btn-outline-secondary d-none" type="button" id="downloadBtn" disabled>
                Download CSV
              </button>
            </div>

            {% if form.url.help_text %}
              <div class="form-text text-start mt-2">{{ form.url.help_text }}</div>
            {% endif %}

            {% for error in form.url.errors %}
              <div class="text-danger text-start mt-1">{{ error }}</div>
            {% endfor %}
          </form>
        </div>

        <div class="mt-4 mx-auto d-none" id="scanProgress" style="max-width: 700px;">
          <div class="d-flex align-items-center gap-2 justify-content-center">
            <div class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></div>
            <div class="text-start">
              <strong id="progressTitle">Scan in progress…</strong>
              <span class="text-muted small border-start ps-2 ms-2" id="progressText">Starting…</span>
            </div>
          </div>

          <div class="progress mt-2" style="height: 8px;">
            <div
              id="progressBar"
              class="progress-bar progress-bar-striped progress-bar-animated"
              role="progressbar"
              style="width: 0%;"
              aria-valuenow="0"
              aria-valuemin="0"
              aria-valuemax="100"
            ></div>
          </div>
          <p class="text-muted small mt-2">Please keep this tab open while the scan runs.</p>
        </div>
      </div>

      <div id="resultsArea" class="w-100 cookie-audit-results"></div>

  </div>

  <div class="mt-5 text-center cookie-audit-footer">
    {% include 'includes/attribution.html' %}
  </div>

</div>

<script>
(function () {
  const form = document.getElementById("cookieAuditForm");
  const btn = document.getElementById("scanBtn");
  const downloadBtn = document.getElementById("downloadBtn");
  let currentDownloadUrl = "";
  const scanProgress = document.getElementById("scanProgress");
  const progressTitle = document.getElementById("progressTitle");
  const progressText = document.getElementById("progressText");
  const progressBar = document.getElementById("progressBar");
  const resultsArea = document.getElementById("resultsArea");

  function getCookie(name) {
    const v = document.cookie.split(";").map(s => s.trim());
    for (const part of v) {
      if (part.startsWith(name + "=")) return decodeURIComponent(part.slice(name.length + 1));
    }
    return "";
  }

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function setProgress(percent) {
    const p = Math.max(0, Math.min(100, Number(percent) || 0));
    progressBar.style.width = p + "%";
    progressBar.setAttribute("aria-valuenow", String(p));
  }

  function showProgress() {
    scanProgress.classList.remove("d-none");
  }

  function hideProgress() {
    scanProgress.classList.add("d-none");
  }

  async function poll(statusUrl, resultsUrl, downloadUrl) {
    try {
      const res = await fetch(statusUrl, { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error("status not ok");
      const contentType = (res.headers.get("content-type") || "").toLowerCase();
      const raw = await res.text();

      let data = null;
      if (contentType.includes("application/json")) {
        try { data = JSON.parse(raw); } catch (e) {}
      }

      if (!data) {
        throw new Error(raw.slice(0, 200) || "Non-JSON response from server");
      }

      const state = data.state;
      const p = data.progress || {};
      const visited = p.visited || 0;
      const maxPages = p.max_pages || 0;
      const currentUrl = p.current_url || "";
      const percent = p.percent || 0;
      const qpos = data.queue_position;

      if (state === "queued") {
        progressTitle.textContent = "Queued…";
        if (typeof qpos === "number" && qpos > 0) {
          progressText.textContent = `In queue (position ${qpos})…`;
        } else {
          progressText.textContent = "Waiting to start…";
        }
        setProgress(0);
      } else if (state === "running") {
        progressTitle.textContent = "Scan in progress…";
        if (maxPages) {
          progressText.textContent =
            `Visited ${visited}/${maxPages}` + (currentUrl ? ` — ${currentUrl}` : "");
        } else {
          progressText.textContent = currentUrl || "Working…";
        }
        setProgress(percent);
      } else if (state === "error") {
        progressTitle.textContent = "Scan failed.";
        progressText.textContent = data.error || "Unknown error";
        btn.disabled = false;
        btn.textContent = "Scan Cookies";
        downloadBtn.classList.add("d-none");
        currentDownloadUrl = "";
        return;
      } else if (state === "done") {
        progressTitle.textContent = "Complete.";
        progressText.textContent = "Rendering results…";
        setProgress(100);

        const r = await fetch(resultsUrl, { headers: { "Accept": "application/json" } });
        const rd = await r.json();
        const results = rd.results || {};
        renderResults(results, downloadUrl);
        currentDownloadUrl = downloadUrl || "";
        downloadBtn.disabled = !currentDownloadUrl;
        if (currentDownloadUrl) {
          downloadBtn.classList.remove("d-none");
        } else {
          downloadBtn.classList.add("d-none");
        }
        hideProgress();
        btn.disabled = false;
        btn.textContent = "Scan Cookies";
        return;
      }
    } catch (e) {
      progressText.textContent = "Still working…";
    }

    setTimeout(() => poll(statusUrl, resultsUrl, downloadUrl), 1000);
  }

  function renderResults(results, downloadUrl) {
    const summary = results.summary || {};
    const cookies = Array.isArray(results.cookies) ? results.cookies : [];

    let rows = "";
    for (const c of cookies) {
      // Accessibility: Using <th scope="row"> for the name makes the table accessible
      rows += `
        <tr>
          <th scope="row" class="fw-normal font-monospace text-break" data-label="Cookie name">${escapeHtml(c.name)}</th>
          <td data-label="Cookie type">${escapeHtml(c.cookie_type)}</td>
          <td data-label="Purpose">${escapeHtml(c.purpose)}</td>
          <td data-label="Party">${escapeHtml(c.party)}</td>
          <td data-label="Domain" class="font-monospace text-break">${escapeHtml(c.domain)}</td>
          <td data-label="Expires">${escapeHtml(c.expires_human)}</td>
          <td data-label="HttpOnly">${escapeHtml(c.httpOnly ? "Yes" : "No")}</td>
          <td data-label="Secure">${escapeHtml(c.secure ? "Yes" : "No")}</td>
          <td data-label="SameSite">${escapeHtml(c.sameSite)}</td>
        </tr>
      `;
    }

    if (!rows) {
      rows = `
        <tr>
          <td colspan="9" class="text-center py-3">No cookies detected on this page.</td>
        </tr>
      `;
    }

    resultsArea.innerHTML = `
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
           <h2 class="h5 mb-0">Summary</h2>
        </div>
        <div class="card-body">
            <ul class="list-unstyled mb-0 row">
                <li class="col-md-4 mb-2 mb-md-0"><strong>Base domain:</strong> ${escapeHtml(summary.base_registrable_domain)}</li>
                <li class="col-md-4 mb-2 mb-md-0"><strong>Pages visited:</strong> ${escapeHtml(summary.visited_urls)}</li>
                <li class="col-md-4"><strong>Total detected cookies:</strong> ${escapeHtml(summary.cookies_detected_total)}</li>
            </ul>
        </div>
      </div>

      <h2 class="h4 mb-3">Cookies Found</h2>

      <div class="table-responsive shadow-sm rounded">
        <table class="table table-striped table-hover table-sm mb-0 cookie-table align-middle">
            <thead class="table-dark">
            <tr>
                <th scope="col" style="min-width: 150px;">Cookie name</th>
                <th scope="col">Cookie type</th>
                <th scope="col">Purpose</th>
                <th scope="col">Party</th>
                <th scope="col">Domain</th>
                <th scope="col">Expires</th>
                <th scope="col">HttpOnly</th>
                <th scope="col">Secure</th>
                <th scope="col">SameSite</th>
            </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }

  form.addEventListener("submit", async function (ev) {
    currentDownloadUrl = "";
    downloadBtn.disabled = true;
    downloadBtn.classList.add("d-none");
    ev.preventDefault();

    resultsArea.innerHTML = "";

    btn.disabled = true;
    btn.textContent = "Starting…";
    showProgress();
    progressTitle.textContent = "Starting…";
    progressText.textContent = "Submitting scan…";
    setProgress(0);

    try {
      const formData = new FormData(form);
      const startUrl = form.getAttribute("action");

      const res = await fetch(startUrl, {
        method: "POST",
        body: formData,
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Accept": "application/json"
        }
      });

      const contentType = (res.headers.get("content-type") || "").toLowerCase();
      const raw = await res.text();

      let data = null;
      if (contentType.includes("application/json")) {
        try { data = JSON.parse(raw); } catch (e) {}
      }

      if (!data) {
        throw new Error(raw.slice(0, 200) || "Non-JSON response from server");
      }

      if (!res.ok) throw new Error(data.error || "Invalid request");

      btn.textContent = "Scanning…";
      poll(data.status_url, data.results_url, data.download_url);

    } catch (e) {
      progressTitle.textContent = "Scan failed.";
      progressText.textContent = e.message || "Unknown error";
      btn.disabled = false;
      btn.textContent = "Scan Cookies";
    }
  });

  downloadBtn.addEventListener("click", async function () {
    if (!currentDownloadUrl) return;

    downloadBtn.disabled = true;

    try {
      const res = await fetch(currentDownloadUrl, { headers: { "Accept": "text/csv" } });
      if (!res.ok) throw new Error("Download failed.");

      let filename = "cookie_audit.csv";
      const disp = res.headers.get("content-disposition") || "";
      const m = disp.match(/filename\*=UTF-8''([^;]+)|filename="([^"]+)"/i);
      if (m) filename = decodeURIComponent(m[1] || m[2]);

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(() => URL.revokeObjectURL(url), 1500);

      downloadBtn.classList.add("d-none");
      currentDownloadUrl = "";

    } catch (e) {
      downloadBtn.disabled = false;
      alert(e.message || "Could not download CSV. Please try again.");
    }
  });
})();
</script>

<script>
  if (window.self !== window.top) {
    document.documentElement.classList.add("embedded");
  }
</script>
{% endblock content %}