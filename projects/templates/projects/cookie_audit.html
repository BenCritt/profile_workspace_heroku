{% extends "projects/base.html" %}
{% load static %}

{% block meta_tags %}
  <!-- Prevent caching -->
  <meta http-equiv="Cache-Control"  content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma"         content="no-cache">
  <meta http-equiv="Expires"        content="0">

  <meta name="description" content="Scan a website to find cookies being set, classify them, and export results to CSV.">
  <meta name="keywords" content="cookie audit, cookies, compliance, privacy, web audit, GDPR, CCPA">

  <meta property="og:url" content="https://www.bencritt.net/projects/cookie-audit/">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Cookie Audit">
  <meta property="og:description" content="Scan a website for cookies and export a report.">
  <meta property="og:image" content="https://www.bencritt.net/static/img/all-projects/cookie-audit.webp">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:domain" content="bencritt.net">
  <meta name="twitter:url" content="https://www.bencritt.net/projects/cookie-audit/">
  <meta name="twitter:title" content="Cookie Audit">
  <meta name="twitter:description" content="Scan a website for cookies and export a report.">
  <meta name="twitter:image" content="https://www.bencritt.net/static/img/all-projects/cookie-audit.webp">
  <meta name="twitter:creator" content="@bencritt89"/>
{% endblock meta_tags %}

{% block link_tags %}
  <link rel="canonical" href="https://www.bencritt.net/projects/cookie-audit/">
  <link href="{% static 'template-css/cookie-audit-css.css' %}" rel="stylesheet">
{% endblock link_tags %}

{% block title %}Cookie Audit | Scan a Website for Cookies and Export a Report{% endblock title %}

{% block content %}
  <section class="py-4">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-8">

          <header class="text-center mb-4">
            <h1 class="mb-2">Cookie Audit</h1>
            <p class="mb-0 text-muted">
              Scan a site for cookies being set and export a report.
            </p>
          </header>

          <div class="card shadow-sm">
            <div class="card-body">
              <form id="cookieAuditForm" method="post" novalidate>
                {% csrf_token %}

                <div class="mb-2">
                  <label for="{{ form.url.id_for_label }}" class="form-label">URL</label>
                  {{ form.url }}
                  {% if form.url.help_text %}
                    <div class="form-text">{{ form.url.help_text }}</div>
                  {% endif %}
                  {% for error in form.url.errors %}
                    <div class="text-danger">{{ error }}</div>
                  {% endfor %}
                </div>

                <div class="d-grid gap-2">
                  <button id="scanBtn" class="btn btn-primary" type="submit">Scan</button>
                  <button id="downloadBtn" class="btn btn-secondary d-none" type="button" disabled>Download CSV</button>
                </div>
              </form>

              <div class="mb-4 d-none" id="scanProgress">
                <div class="d-flex align-items-center gap-2">
                  <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
                  <div>
                    <strong id="progressTitle">Scan in progress…</strong>
                    <span class="text-muted" id="progressText">Starting…</span>
                  </div>
                </div>

                <div class="progress mt-2 cookie-audit-progress">
                  <div
                    id="progressBar"
                    class="progress-bar"
                    role="progressbar"
                    aria-valuenow="0"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  ></div>
                </div>

                <div class="form-text mt-2">
                  Please keep this tab open while the scan runs.
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <section class="cookie-audit-results">
    <div class="container py-4 cookie-audit-results-container">
      <div id="resultsArea"></div>
    </div>
  </section>

  <div class="text-center mt-4">
    <a
      href="https://github.com/BenCritt/profile_workspace_heroku"
      target="_blank"
      rel="noopener noreferrer"
      class="btn btn-outline-secondary"
      data-bs-toggle="tooltip"
      title="View the source code for this app.">
      View source on GitHub
    </a>

    <p class="mt-3 text-muted small mb-0">
      This tool was created by
      <a href="{% url 'projects:home' %}" class="content-link" title="Ben Crittenden – IT Professional">Ben Crittenden</a>,
      an IT professional with experience in web development, systems administration, and project management.
    </p>
  </div>

  <script>
    (function () {
      const form = document.getElementById("cookieAuditForm");
      const btn = document.getElementById("scanBtn");
      const downloadBtn = document.getElementById("downloadBtn");
      let currentDownloadUrl = "";
      const scanProgress = document.getElementById("scanProgress");
      const progressTitle = document.getElementById("progressTitle");
      const progressText = document.getElementById("progressText");
      const progressBar = document.getElementById("progressBar");
      const resultsArea = document.getElementById("resultsArea");

      // Initialize UI state (avoid inline styles in markup)
      if (progressBar) progressBar.style.width = "0%";

      function getCookie(name) {
        const v = document.cookie.split(";").map(s => s.trim());
        for (const part of v) {
          if (part.startsWith(name + "=")) return decodeURIComponent(part.slice(name.length + 1));
        }
        return "";
      }

      function escapeHtml(s) {
        return String(s ?? "").replace(/[&<>"']/g, (c) => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[c]));
      }

      function setProgress(pct, title, msg) {
        const clamped = Math.max(0, Math.min(100, Number(pct || 0)));
        if (progressBar) {
          progressBar.style.width = clamped + "%";
          progressBar.setAttribute("aria-valuenow", String(clamped));
        }
        if (progressTitle && title) progressTitle.textContent = title;
        if (progressText && msg) progressText.textContent = msg;
      }

      function setDownloadingAvailable(url) {
        currentDownloadUrl = url || "";
        downloadBtn.classList.toggle("d-none", !currentDownloadUrl);
        downloadBtn.disabled = !currentDownloadUrl;
      }

      async function startScan(url) {
        setDownloadingAvailable("");
        resultsArea.innerHTML = "";
        scanProgress.classList.remove("d-none");
        setProgress(1, "Scan in progress…", "Starting…");

        const payload = new FormData();
        payload.append("url", url);

        const r = await fetch("{% url 'projects:cookie_audit_start' %}", {
          method: "POST",
          credentials: "same-origin",
          headers: { "X-CSRFToken": getCookie("csrftoken") },
          body: payload
        });

        const j = await r.json();
        if (!j.task_id) throw new Error("No task id returned");
        return j.task_id;
      }

      async function poll(taskId) {
        const statusUrl = "{% url 'projects:cookie_audit_status' 'TASKID' %}".replace("TASKID", taskId);

        const r = await fetch(statusUrl, { credentials: "same-origin" });
        const j = await r.json();

        const pct = j.progress_percent ?? 0;
        setProgress(pct, j.title || "Scan in progress…", j.message || "Working…");

        if (j.state === "SUCCESS") {
          scanProgress.classList.add("d-none");
          if (j.download_url) setDownloadingAvailable(j.download_url);
          if (j.html) {
            resultsArea.innerHTML = j.html;

            // Ensure your column-width CSS can apply
            const table =
              resultsArea.querySelector("table.cookie-audit-results-table") ||
              resultsArea.querySelector("table.cookie-table") ||
              resultsArea.querySelector("table");

            if (table) {
              table.classList.add("cookie-audit-results-table");

              // Add colgroup if missing
              let colgroup = table.querySelector("colgroup");
              if (!colgroup) {
                colgroup = document.createElement("colgroup");
                for (let i = 1; i <= 9; i++) {
                  const col = document.createElement("col");
                  col.className = `ca-col-${i}`;
                  colgroup.appendChild(col);
                }
                table.prepend(colgroup);
              } else {
                // Ensure expected col classes exist
                const cols = colgroup.querySelectorAll("col");
                if (cols.length < 9) {
                  for (let i = cols.length + 1; i <= 9; i++) {
                    const col = document.createElement("col");
                    col.className = `ca-col-${i}`;
                    colgroup.appendChild(col);
                  }
                }
                colgroup.querySelectorAll("col").forEach((col, idx) => {
                  col.classList.add(`ca-col-${idx + 1}`);
                });
              }
            }
          }
          return true;
        }

        if (j.state === "FAILURE") {
          scanProgress.classList.add("d-none");
          resultsArea.innerHTML = `<div class="alert alert-danger">Scan failed. Please try again.</div>`;
          setDownloadingAvailable("");
          return true;
        }

        return false;
      }

      let pollTimer = null;

      function stopPolling() {
        if (pollTimer) window.clearInterval(pollTimer);
        pollTimer = null;
      }

      form?.addEventListener("submit", async function (ev) {
        ev.preventDefault();
        const urlInput = form.querySelector('input[name="url"]');
        const url = urlInput?.value?.trim();
        if (!url) return;

        btn.disabled = true;

        try {
          stopPolling();
          const taskId = await startScan(url);
          pollTimer = window.setInterval(async () => {
            const done = await poll(taskId);
            if (done) {
              stopPolling();
              btn.disabled = false;
            }
          }, 1200);
        } catch (e) {
          stopPolling();
          scanProgress.classList.add("d-none");
          resultsArea.innerHTML = `<div class="alert alert-danger">Could not start scan. Please try again.</div>`;
          btn.disabled = false;
        }
      });

      downloadBtn?.addEventListener("click", function () {
        if (!currentDownloadUrl) return;
        window.location.href = currentDownloadUrl;
      });

      // NOTE: Your results HTML builder in JS should use this table markup (kept consistent):
      // <table class="table ... cookie-table cookie-audit-results-table">
      //   <colgroup>
      //     <col class="ca-col-1"> ... <col class="ca-col-9">
      //   </colgroup>
      // </table>
    })();
  </script>
{% endblock content %}