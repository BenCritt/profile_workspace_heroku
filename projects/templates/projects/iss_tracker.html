{% extends "projects/base.html" %}
{% load static %}

{% block scripts %}
    {% include "includes/schemas/iss_tracker_schema.html" %}
{% endblock scripts %}

{% block meta_tags %}
    <meta http-equiv="Cache-Control"  content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma"         content="no-cache">
    <meta http-equiv="Expires"        content="0">

    <meta name="description"          content="Track the International Space Station (ISS) in real-time with the ISS Tracker. View the current location, altitude, velocity, and regional position of the ISS.">

    <meta property="og:url"           content="https://www.bencritt.net/projects/iss-tracker/">
    <meta property="og:type"          content="website">
    <meta property="og:title"         content="ISS Tracker">
    <meta property="og:description"   content="Track the International Space Station (ISS) in real-time. View current location, altitude, and velocity.">
    <meta property="og:image"         content="https://www.bencritt.net/static/img/all-projects/iss-tracker.webp">
    <meta property="og:image:type"    content="image/webp">
    <meta property="og:image:alt"     content="ISS Tracker Screenshot">
    <meta property="og:site_name"     content="Ben Crittenden">

    <meta name="twitter:card"         content="summary_large_image">
    <meta name="twitter:domain"       content="bencritt.net">
    <meta name="twitter:url"          content="https://www.bencritt.net/projects/iss-tracker/">
    <meta name="twitter:title"        content="ISS Tracker">
    <meta name="twitter:description"  content="Track the International Space Station (ISS) in real-time. View current location, altitude, and velocity.">
    <meta name="twitter:image"        content="https://www.bencritt.net/static/img/all-projects/iss-tracker.webp">
    <meta name="twitter:creator"      content="@bencritt89">
{% endblock meta_tags %}

{% block link_tags %}
    <link rel="canonical" href="https://www.bencritt.net/projects/iss-tracker/">
{% endblock link_tags %}

{% block title %}ISS Tracker | Real-Time International Space Station Tracking Tool{% endblock title %}

{% block content %}
<div class="container py-5 d-flex flex-column align-items-center">
    
    <h1 class="mb-4">International Space Station Tracker</h1>
    
    <form method="POST" class="mb-5 text-center w-100" style="max-width: 500px;">
        {% csrf_token %}
        <div class="mb-3">
            {{ form.as_p }}
        </div>
        <input type="submit" id="iss-track-btn" class="btn btn-primary w-100" value="Project ISS Passover Schedule" aria-label="Project ISS Passover Schedule">
    </form>
    
    <h2 class="h4 mb-3 mt-2">Current ISS Data</h2>
    
    <div class="table-responsive w-100 mb-5 shadow-sm rounded" style="max-width: 800px;">
        <table class="table table-striped table-bordered mb-0 text-center align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col">Latitude</th>
                    <th scope="col">Longitude</th>
                    <th scope="col">Region</th>
                    <th scope="col">Altitude</th>
                    <th scope="col">Velocity</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="latitude">{{ current_data.latitude|default:"Loading..." }}</td>
                    <td id="longitude">{{ current_data.longitude|default:"Loading..." }}</td>
                    <td id="region">{{ current_data.region|default:"Loading..." }}</td>
                    <td id="altitude">{{ current_data.altitude|default:"Loading..." }}</td>
                    <td id="velocity">{{ current_data.velocity|default:"Loading..." }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    {% if iss_pass_times %}
        <h2 class="h4 mb-3">Upcoming ISS Pass Times</h2>
        <div class="table-responsive w-100 mb-4 shadow-sm rounded" style="max-width: 800px;">
            <table class="table table-hover mb-0 text-center align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col">Status</th>
                        <th scope="col">Date</th>
                        <th scope="col">Time</th>
                        <th scope="col">Position</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pass in iss_pass_times %}
                    <tr>
                        <td>{{ pass.event }}</td>
                        <td>{{ pass.date }}</td>
                        <td>{{ pass.time }}</td>
                        <td>{{ pass.position }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% elif error %}
        <div class="alert alert-danger w-100 text-center" style="max-width: 600px;" role="alert">
            {{ error }}
        </div>
    {% endif %}

    <div class="mt-4 text-center">
        {% include 'includes/attribution.html' %}
    </div>

</div>

<script>
    (function() {
        /**
         * Fetches current ISS data and updates the DOM.
         * Note: This requires a corresponding JSON endpoint '/current-iss-data/' 
         * to be defined in your urls.py/views.py.
         */
        function updateCurrentData() {
            fetch('/current-iss-data/')
                .then(response => {
                    if (!response.ok) {
                        // Silently fail if the endpoint doesn't exist yet
                        return null; 
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return;
                    
                    // Update DOM elements safely
                    const fields = ['latitude', 'longitude', 'region', 'altitude', 'velocity'];
                    fields.forEach(field => {
                        const el = document.getElementById(field);
                        if (el && data[field]) el.innerText = data[field];
                    });
                })
                .catch(error => console.warn("Error fetching current ISS data:", error));
        }

        document.addEventListener('DOMContentLoaded', () => {
                    // Only run if the table cells exist
                    if(document.getElementById('latitude')) {
                        updateCurrentData(); // <--- Add this line to run immediately
                        setInterval(updateCurrentData, 60000);
                    }
                });
    })();
</script>
{% endblock content %}