{% extends "projects/base.html" %}
{% load static %}

{% block scripts %}
    {% include "includes/schemas/iss_tracker_schema.html" %}
{% endblock scripts %}

{% block meta_tags %}
    {% include "includes/meta_tags/iss_tracker_meta.html" %}
{% endblock meta_tags %}

{% block link_tags %}
    {{ block.super }}
    <link rel="canonical" href="https://www.bencritt.net/projects/iss-tracker/">
{% endblock link_tags %}

{% block page_stylesheets %}
  <link href="{% static 'template_css/iss_tracker.css' %}" rel="stylesheet">
{% endblock page_stylesheets %}

{% block title %}ISS Tracker | Real-Time International Space Station Tracking Tool{% endblock title %}

{% block content %}
<div class="container py-5 d-flex flex-column align-items-center">
    
    <h1 class="mb-4">International Space Station Tracker</h1>
    
    <form method="POST" class="mb-5 text-center w-100 iss-form-container">
        {% csrf_token %}
        <div class="mb-3">
            {{ form.as_p }}
        </div>
        <input type="submit" id="iss-track-btn" class="btn btn-primary w-100" value="Project ISS Passover Schedule" aria-label="Project ISS Passover Schedule">

        {# ── Back Button (Inside Form) ── #}
        <p class="mt-3 text-center">
            <a href="{% url 'projects:space_and_astronomy' %}" class="btn btn-secondary w-100 mt-2">
                <i class="bi bi-grid-3x3-gap-fill me-2"></i>Back to Space Toolkit
            </a>
        </p>
    </form>
    
    <h2 class="h4 mb-3 mt-2">Current ISS Data</h2>
    
    <div class="table-responsive w-100 mb-5 shadow-sm rounded" style="max-width: 800px;">
        <table class="table table-striped table-bordered mb-0 text-center align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col">Latitude</th>
                    <th scope="col">Longitude</th>
                    <th scope="col">Region</th>
                    <th scope="col">Altitude</th>
                    <th scope="col">Velocity</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="latitude">{{ current_data.latitude|default:"Loading..." }}</td>
                    <td id="longitude">{{ current_data.longitude|default:"Loading..." }}</td>
                    <td id="region">{{ current_data.region|default:"Loading..." }}</td>
                    <td id="altitude">{{ current_data.altitude|default:"Loading..." }}</td>
                    <td id="velocity">{{ current_data.velocity|default:"Loading..." }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    {% if iss_pass_times %}
        <h2 class="h4 mb-3">Upcoming ISS Pass Times</h2>
        <div class="table-responsive w-100 mb-4 shadow-sm rounded" style="max-width: 800px;">
            <table class="table table-hover mb-0 text-center align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col">Status</th>
                        <th scope="col">Date</th>
                        <th scope="col">Time</th>
                        <th scope="col">Position</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pass in iss_pass_times %}
                    <tr>
                        <td>{{ pass.event }}</td>
                        <td>{{ pass.date }}</td>
                        <td>{{ pass.time }}</td>
                        <td>{{ pass.position }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% elif error %}
        <div class="alert alert-danger w-100 text-center" style="max-width: 600px;" role="alert">
            {{ error }}
        </div>
    {% endif %}

    <div class="mt-4 text-center">
        {% include 'includes/attribution.html' %}
    </div>

</div>

<script>
    (function() {
        /**
         * Fetches current ISS data and updates the DOM.
         * Note: This requires a corresponding JSON endpoint '/current-iss-data/' 
         * to be defined in your urls.py/views.py.
         */
        function updateCurrentData() {
            fetch('/current-iss-data/')
                .then(response => {
                    if (!response.ok) {
                        // Silently fail if the endpoint doesn't exist yet
                        return null; 
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return;
                    
                    // Update DOM elements safely
                    const fields = ['latitude', 'longitude', 'region', 'altitude', 'velocity'];
                    fields.forEach(field => {
                        const el = document.getElementById(field);
                        if (el && data[field]) el.innerText = data[field];
                    });
                })
                .catch(error => console.warn("Error fetching current ISS data:", error));
        }

        document.addEventListener('DOMContentLoaded', () => {
                    // Only run if the table cells exist
                    if(document.getElementById('latitude')) {
                        updateCurrentData();
                        setInterval(updateCurrentData, 10000); // 10 seconds
                    }
                });
    })();
</script>
{% endblock content %}