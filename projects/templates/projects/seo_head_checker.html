{% extends "projects/base.html" %}
{% load static %}

{% block scripts %}
    {% include "includes/schemas/seo_head_checker_schema.html" %}
{% endblock scripts %}

{% block meta_tags %}
    {% include "includes/meta_tags/seo_head_checker_meta.html" %}
{% endblock meta_tags %}

{% block link_tags %}
    {{ block.super }}
    <link rel="canonical" href="https://www.bencritt.net/projects/seo-head-checker/">
{% endblock link_tags %}

{% block page_stylesheets %}
    <link href="{% static 'template_css/seo_head_checker.css' %}" rel="stylesheet">
{% endblock page_stylesheets %}

{% block title %}SEO Head Checker | Free Tool to Analyze SEO Head Elements{% endblock title %}

{% block content %}
<div class="container py-4 d-flex flex-column align-items-center">
    
    <h1 class="mb-4">SEO Head Checker</h1>
    
    <div class="w-100 seo-tool-container">
        
        <section class="mb-4 text-center">
            <h2 class="h4">Instructions</h2>
            <p class="text-muted">Enter the URL of a sitemap or web page and click the blue "Generate SEO Report" button. Progress will update below. Once complete, click the green "Download" button.</p>
        </section>

        <form method="POST" id="sitemap-form" class="mb-4 d-grid gap-3" onsubmit="return false;"
            data-gtm-tool="SEO Head Checker" data-gtm-category="SEO Tools">
            {% csrf_token %}
            
            <div>
                {{ form.as_p }}
            </div>
            
            <button id="seo-head-btn" class="btn btn-primary w-100" type="button" aria-label="Generate SEO Report">
                Generate SEO Report
            </button>
        </form>

        {% if error %}
            <div class="alert alert-danger" role="alert">
                {{ error }}
            </div>
        {% endif %}

        <div id="status" class="alert alert-info" role="status" aria-live="polite">
            Ready to start.
        </div>

        <a id="download_link"
        class="btn btn-success w-100 mb-4 d-none"
        href="#"
        data-gtm-download="csv"
        data-gtm-tool="SEO Head Checker"
        data-gtm-category="SEO Tools"
        aria-label="Download the generated SEO report">
            Download SEO Report
        </a>

        <section class="mt-5 text-muted small">
            <h3 class="h6">Limitations</h3>
            <p>Reports are limited to the first 1,000 pages. There may be a delay before progress bars update. If you do not download your file within 30 minutes, it will be deleted.</p>
        </section>

        <div class="mt-4 text-center">
            {% include 'includes/attribution.html' %}
        </div>
    </div>

    <script>
    (function() {
        const statusEl = document.getElementById("status");
        // Improved selector to catch the input whether it has ID or just name
        const sitemapInput = document.getElementById("sitemap_url") || document.querySelector('input[name="sitemap_url"]'); 
        const btn = document.getElementById("seo-head-btn");
        const downloadLink = document.getElementById("download_link");
        const form = document.getElementById("sitemap-form");

        function setStatus(message, klass) {
            if (!statusEl) return;
            statusEl.className = `alert ${klass}`;
            statusEl.innerText = message;
        }

        async function startProcessing() {
            // GTM Event Tracking
            if (window.gtmTrack) window.gtmTrack.scanStart("SEO Head Checker", "SEO Tools");
            if (downloadLink) {
                downloadLink.classList.add('d-none');
                downloadLink.removeAttribute("href");
            }

            if (!sitemapInput) { alert("URL input field is missing."); return; }
            const sitemapUrl = sitemapInput.value.trim();
            if (!sitemapUrl) { alert("Please enter a valid URL."); return; }

            try {
                setStatus("Submitting…", "alert-info");
                if (btn) btn.disabled = true;

                const response = await fetch("/start_sitemap_processing/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                    body: JSON.stringify({ sitemap_url: sitemapUrl }),
                });

                let data = {};
                try { data = await response.json(); } catch (_) {}

                if (response.status !== 202) {
                    setStatus((data && data.error) || "Failed to start processing.", "alert-danger");
                    if (btn) btn.disabled = false;
                    return;
                }

                setStatus("Request queued. Waiting for worker...", "alert-warning");
                pollTaskStatus(data.task_id);

            } catch (err) {
                console.error(err);
                setStatus("An error occurred while starting the task.", "alert-danger");
                if (btn) btn.disabled = false;
            }
        }

        async function pollTaskStatus(taskId) {
            const interval = setInterval(async () => {
                let response, data;
                try {
                    response = await fetch(`/get_task_status/${taskId}/`);
                    data = await response.json();
                } catch (err) {
                    console.warn("Polling error:", err);
                    return;
                }

                if (response.status === 404) {
                    clearInterval(interval);
                    setStatus("Error: Task not found.", "alert-danger");
                    if (btn) btn.disabled = false;
                    return;
                }

                if (data.status === "pending" || data.status === "queued") {
                    setStatus("Position in queue: " + (data.queue_position || "Pending"), "alert-warning");
                } else if (data.status === "processing") {
                    setStatus(`Processing: ${data.progress || 0}%`, "alert-info");
                } else if (data.status === "completed") {                    
                    clearInterval(interval);
                    setStatus("Processing completed! 100%", "alert-success");
                    // GTM Event Tracking
                    if (window.gtmTrack) window.gtmTrack.scanComplete("SEO Head Checker", "SEO Tools");

                    if (downloadLink) {
                        downloadLink.href = `/download_task_file/${taskId}/`;
                        downloadLink.classList.remove('d-none');
                    }
                    if (btn) btn.disabled = false;
                } else if (data.status === "error") {
                    clearInterval(interval);
                    setStatus("Error occurred during processing.", "alert-danger");
                    alert(data.error || "An error occurred.");
                    if (btn) btn.disabled = false;
                }
            }, 2000);
        }

        if (btn) {
            btn.addEventListener("click", startProcessing);
        }
        
        if (form) {
            form.addEventListener("keydown", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    if (btn) btn.click();
                }
            });
        }

        if (downloadLink) {
            downloadLink.addEventListener("click", (ev) => {
                const href = downloadLink.href;
                const m = (href || "").match(/\/download_task_file\/([^/]+)\//);
                const taskId = m ? m[1] : null;

                if (!taskId) return;
                ev.preventDefault();

                if (downloadLink.classList.contains("disabled")) return;
                
                downloadLink.classList.add("disabled");
                downloadLink.innerText = "Downloading...";

                downloadWithRetry(taskId).finally(() => {
                    downloadLink.classList.remove("disabled");
                    downloadLink.innerText = "Download SEO Report";
                });
            });
        }

        async function downloadWithRetry(taskId, attempt = 1) {
            const url = `/download_task_file/${taskId}/`;
            try {
                setStatus("Preparing download...", "alert-info");
                const res = await fetch(url);

                if (res.ok) {
                    const blob = await res.blob();
                    
                    const disposition = res.headers.get("Content-Disposition") || "";
                    let filename = `seo_report_${taskId}.csv`;
                    const m = disposition.match(/filename\*?=(?:UTF-8'')?["']?([^"';]+)["']?/i);
                    if (m) filename = decodeURIComponent(m[1]);

                    const downloadUrl = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = downloadUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    setTimeout(() => URL.revokeObjectURL(downloadUrl), 2000);
                    
                    setStatus("Download started.", "alert-success");
                    setTimeout(() => location.reload(), 1500); 
                    return;
                }

                if (res.status === 425 || res.status === 503) {
                    if (attempt >= 10) return;
                    const delay = Math.min(1000 * Math.pow(2, attempt - 1), 8000);
                    setStatus("File is generating... retrying...", "alert-warning");
                    setTimeout(() => downloadWithRetry(taskId, attempt + 1), delay);
                    return;
                }
                
                setStatus("Download failed.", "alert-danger");

            } catch (e) {
                setStatus("Network error.", "alert-danger");
            }
        }
    })();
    </script>

    {# ── Iframe Resize ──────────────────────────────────────── #}
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        if (window.self !== window.top) {
            document.documentElement.classList.add('embedded');

            let lastHeight = 0;
            const sendHeight = () => {
                const h = document.documentElement.scrollHeight;
                if (h !== lastHeight) {
                    lastHeight = h;
                    window.parent.postMessage({ type: 'setHeight', height: h }, '*');
                }
            };
            window.addEventListener('load', sendHeight);
            window.addEventListener('resize', sendHeight);
            new ResizeObserver(sendHeight).observe(document.body);
        }
    });
    </script>
</div>
{% endblock content %}